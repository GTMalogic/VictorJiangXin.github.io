---
title: 基于以太坊测量的分片策略探索
date: 2018-07-11
tags: 
	- 以太坊
	- LevelDB
	- 区块链分片
categories: 区块链技术
---
# 老师的奇思妙想
在[V神关于sharding的回答](https://github.com/ethereum/wiki/wiki/Sharding-FAQ) 中，提出了一种分片方案，即使用账户地址对区块链进行分片。
那么，如果我们按照此方式对区块链进行分片，则会出现下面的问题：如果使用账户地址对区块链进行分片， 按照地址前 N 位， 将区块链分成2^N片。 
随着 N 的增大， 分片数量越来越多， 区块链的吞吐量也在不断的变化。 刚开始， 随着分片的增多， 并行化程度增加，区块链的吞吐量必然有提升。
但当分片数量超过一定数量后， 其跨片交易占比也会越来越多， 由于跨片交易需要消耗更多的时间去处理， 因此吞吐量反而会有所降低。 
考虑一种极限的情况，如果每个账户作为一片， 那么每笔交易都属于跨片交易。 此时， 吞吐量会比不采用分片方案的区块链吞吐量更低。
 因此， 在这中间， 必然存在一种最优的分片数量方案， 使得吞吐量达到最大值。
# 老师的要求
根据以太坊现有的历史交易记录， 统计交易记录在地址空间的分布情况， 并进一步从理论上计算出 Sharding 能取得的性能上界以及性能上界所对应的分片数量，
从而对以太坊分片方案的实际部署提供理论指导和依据。
# 我的疑惑
1. 分片应该是在网络层进行分片，即将以太坊节点进行分片，这样假设每一分片每一时间段处理N比交易，则每一时间段处理的交易总量为N*m，m为分片数量。
而老师所提出的是基于交易账户地址进行分片，也就是在应用层上的分片。这就比较难以理解了，难道未来分片，先把节点随机分片，然后相应账户产生一笔
交易则将其先发送至对应的分片节点中进行处理，比如地址开头为01的，则发送至专门处理01地址的分片节点进行处理，从而实现账户地址实现分片。
2. 吞吐量的计算为 单位时间处理的交易量即 处理的交易量/处理的时间，此时我们按照片内单笔交易处理时间不变，片间交易处理时间为之前的a倍，则可以
粗略计算当前区块链的吞吐量。但是，我们对以太坊区块链进行数据测量，测量它们片内、片间的交易量。但这是统计量呀！如果我们划分一个时间窗，在该时间
窗内，处理了A笔片内交易，B笔片间交易，那么这些交易如果计算时间，则应该花费总时间为 A/15+B/15*a ，则吞吐量为（A+B)/(A/15+B/15*a)。但是随着时间
窗的取法不同，获取的结果也是不同的，那么我们该怎样去确定这个值呢？取平均值？或者说，我们应该去估计非交易量占总交易量的比值。个人觉得计算这个
比例比较靠谱！

不管有多少疑惑，活还是要干的！开始干活。
# 干活ing
## 初步了解以太坊
首先，阅读[以太坊白皮书](https://github.com/ethereum/wiki/wiki/White-Paper) [以太坊黄皮书](https://ethereum.github.io/yellowpaper/paper.pdf) ，
初步了解以太坊。
主要了解：
1. 以太坊的数据结构。
2. 以太坊的工作原理。
## 安装以太坊客户端（go-ethereum）
由于需要同步以太坊的全节点，因此其占据的空间十分巨大，在安装全节点前，需要保证你的服务器至少有足够的空间。
我们的服务器搭载的是Ubuntu系统，我们安装的是go版的以太坊客户端。相关安装指令如下所示。
1. 安装软件依赖包。
`sudo apt-get install software-properties-common`
2. 添加ppa软件源
`sudo add-apt-repository -y ppa:etherum/ethereum`
3. 更新软件状态
`sudo apt-get update`
4. 安装以太坊客户端
`sudo apt-get install etherum`
5. 运行geth客户端，由于geth运行后不会自动转到后台，关掉客户端后也会自动停止，因此要使用nohup指令。
`nohup geth &`
## 探索以太坊区块链的数据存储
以前在弄比特币测量项目时，比特币的区块链数据是存储在隐藏文件夹.bitcoin中，其按照比特币区块的数据结构存储在.dat文件中，因此刚开始，我想以太坊应该以
类似的形式存储，进行探索后，发现以太坊区块链的数据存储在.ethereum/geth/chaindata/ 中，它的保存文件为.ldb的形式。这个看上去与比特币存在较大的不同，
因此，去查询.ldb文件类型，发现它是LevelDB的存储文件。为了获取以太坊数据，必须要去了解LevelDB。
# 初探LevelDB
1. 首先，查看相关博客[levelDB的技术博客](https://catkang.github.io) ，初步了解LevelDB的数据存储结构，对LevelDB有个模糊的了解。
2. 为了锻炼自己的软件能力，必须去从源码上，从作者给的WIKI上，进行开发，而不是去查询博客，来调研LevelDB的使用。查询Github的LevelDB项目












